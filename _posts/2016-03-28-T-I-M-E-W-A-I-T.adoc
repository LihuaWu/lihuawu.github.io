= 网络编程中的TIME-WAIT状态详解

1. 通常，只有一端---主动关闭的那一端会进入TIME-WAIT状态。
	主动关闭表示发送第一条FIN的那一端。另一端被称为被动关闭。如果两端同时关闭连接，就认为两个应用程序都进行了主动关闭，两端都会进入TIME-WAIT状态。

2. 连接会在TIME-WAIT状态停留2MSL时间，一般为从0.5-2分钟之间。
3. 在连接牌TIME-WAIT状态时有分组到达，就重启2MSL的定时器。

使用TIME-WAIT状态的两个目的

1. 维护连接状态， 以防止主动关闭连接的那端发送的最后一条ACK丢失后造成另一端重新发送FIN信号。
   重传FIN后，由于此时对端连接已经被关闭，因此会响应以RST, 造成会造成本端产生一个错误状态， 而不是有序的终止。

2. 为耗尽网络中所有此连接的“走丢段”提供时间。

	对于第二点， 前提是在WAN中，IP数据报可能会丢失或延迟，TCP会用肯定确认机制来重传那些没有被对等实体以即时方式ACK的段，如果数据报只是延迟，而没有丢失，或者是对数据报的ACK丢失了，那么重传的数据可能会在收到原始数据之后到达。此时TCP会注意到延迟数据的序列号在当前接收端窗口之外，并将其丢弃。

	如果延迟或重传的段在连接关闭之后到达，通常在这种情况下，TCP只是将数据丢失并以RST进行响应，所以不会产生什么问题。当RST到达发送延迟分段的主机时，这台主机中也没有这条连接的记录了，所以RST也会被丢失。但是，如果在这两台主机间用同样的端口后建立了一条新连接， 这条走失的段看起来就像属于那条新连接。如果走失分段中数据的任意一个序列号碰巧落在了新连接的当前接收窗口中，这部分数据就会被接受，从而对新连接造成破坏。TIME-WAIT状态确保了在原有连接的所有分段从网络中消失之前，不会再次使用原来用过的socket对，以此来防止这类问题的发生。没有它，TCP就无法承诺将数据“按序且无差错地”传递。

